<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czech Flashcard App - Spaced Repetition</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🇨🇿</text></svg>">
    <meta name="description" content="Learn Czech vocabulary with spaced repetition and cloud sync!">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3B82F6">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createClient } = supabase;

        // Enhanced logging system
const createLogger = (component) => {
    const formatMessage = (level, message, data = null) => {
        const timestamp = new Date().toISOString();
        const prefix = `[${timestamp}] [${component}] [${level.toUpperCase()}]`;
        
        if (data) {
            console.log(`${prefix} ${message}`, data);
        } else {
            console.log(`${prefix} ${message}`);
        }
    };

    return {
        info: (message, data) => formatMessage('info', message, data),
        warn: (message, data) => formatMessage('warn', message, data),
        error: (message, data) => formatMessage('error', message, data),
        debug: (message, data) => formatMessage('debug', message, data),
        trace: (functionName, params) => formatMessage('trace', `Entering ${functionName}`, params)
    };
};

        // Supabase credentials
        const supabaseUrl = 'https://luydswutvsttbpvruylm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eWRzd3V0dnN0dGJwdnJ1eWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MDQzMjgsImV4cCI6MjA2NDE4MDMyOH0.RvrljR2_T4oDCWkyrvCxPSRc7aiUYflzQ8sX_cU-urI';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        const CzechFlashcardApp = () => {
            // All state variables
            const [currentScreen, setCurrentScreen] = useState('login');
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [studyCards, setStudyCards] = useState([]);
            const [sessionStats, setSessionStats] = useState({
                cardsStudied: 0,
                newCards: 0,
                reviewCards: 0,
                againCards: 0,
                easyCards: 0,
                normalCards: 0,
                hardCards: 0
            });
            const [allVocabulary, setAllVocabulary] = useState([]);
            const [manualCzech, setManualCzech] = useState('');
            const [manualEnglish, setManualEnglish] = useState('');
            const [userId, setUserId] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [connectionError, setConnectionError] = useState(null);
            const [csvCards, setCsvCards] = useState([]);
            const [csvValidationResults, setCsvValidationResults] = useState([]);
            const [isProcessingCsv, setIsProcessingCsv] = useState(false);
            const csvInputRef = useRef(null);
            const [typingGameCards, setTypingGameCards] = useState([]);
            const [typingCurrentIndex, setTypingCurrentIndex] = useState(0);
            const [userInput, setUserInput] = useState('');
            const [showFeedback, setShowFeedback] = useState(false);
            const [isCorrect, setIsCorrect] = useState(false);
            const [typingRecallMode, setTypingRecallMode] = useState('czech-to-english'); // or 'english-to-czech'
            const [activeRecallStats, setActiveRecallStats] = useState({
                totalAttempts: 0,
                correctAnswers: 0,
                sessionCorrect: 0,
                sessionTotal: 0
            });
            const [difficultWords, setDifficultWords] = useState(new Set());
            const [sessionWrongCards, setSessionWrongCards] = useState([]);
            const [feedbackText, setFeedbackText] = useState('');
            const [feedbackType, setFeedbackType] = useState('');
            const logger = createLogger('CzechFlashcardApp');


            // Spaced Repetition Algorithm - Based on Anki's SM-2 algorithm
            const calculateNextReview = (card, grade) => {
    const now = new Date();
    
    let interval = card.interval || 1;
    let easeFactor = card.easeFactor || 2.5;
    let repetitions = card.repetitions || 0;

    if (grade < 3) {
        // If failed (grade 0-2), reset repetitions
        repetitions = 0;
        interval = 1;
    } else {
        repetitions += 1;
        
        // Fixed interval calculation
        if (repetitions === 1) {
            interval = 1;        // First success: 1 day
        } else if (repetitions === 2) {
            interval = 6;        // Second success: 6 days  
        } else {
            // For subsequent reviews, use the previous interval * ease factor
            interval = Math.round(interval * easeFactor);
        }

        // Adjust easeFactor based on grade (Anki's formula)
        easeFactor += (0.1 - (5 - grade) * (0.08 + (5 - grade) * 0.02));
        if (easeFactor < 1.3) easeFactor = 1.3;
        
        // Grade-specific interval adjustments
        if (grade === 3) { // Hard
            interval = Math.round(interval * 0.8); // 20% reduction
        } else if (grade === 5) { // Easy
            interval = Math.round(interval * 1.3); // 30% increase
            easeFactor += 0.15; // Bonus ease increase for easy cards
        }
    }

    const nextReviewDate = new Date(now);
    nextReviewDate.setDate(now.getDate() + interval);

    return {
        nextReviewDate: nextReviewDate.toISOString(),
        interval,
        easeFactor: Math.round(easeFactor * 100) / 100,
        repetitions,
        lastReviewed: now.toISOString()
    };
};


            // Get cards due for review
            const getCardsForStudy = (maxNewCards = 20, maxReviewCards = 100) => {
    const now = new Date();
    
    // Separate new cards from review cards
    const newCards = allVocabulary.filter(card => !card.lastReviewed);
    const reviewCards = allVocabulary.filter(card => 
        card.lastReviewed && 
        card.nextReviewDate && 
        new Date(card.nextReviewDate) <= now
    );
    
    // Sort review cards by how overdue they are (most overdue first)
    const sortedReviewCards = reviewCards.sort((a, b) => {
        const aDate = new Date(a.nextReviewDate);
        const bDate = new Date(b.nextReviewDate);
        return aDate - bDate; // Earlier dates first (more overdue)
    });
    
    // Sort new cards randomly for variety
    const shuffledNewCards = [...newCards].sort(() => Math.random() - 0.5);
    
    // Apply limits
    const selectedReviewCards = sortedReviewCards.slice(0, maxReviewCards);
    const selectedNewCards = shuffledNewCards.slice(0, maxNewCards);
    
    // Combine with review cards first (they're more important)
    return [...selectedReviewCards, ...selectedNewCards];
};

            // Update card after review
            const updateCardProgress = (cardIndex, difficulty) => {
                const card = studyCards[cardIndex];
                const originalIndex = allVocabulary.findIndex(c => 
                    c.czech === card.czech && c.english === card.english
                );
                
                if (originalIndex === -1) return;
                
                const updatedCard = {
                    ...allVocabulary[originalIndex],
                    ...calculateNextReview(allVocabulary[originalIndex], difficulty)
                };
                
                const updatedVocabulary = [...allVocabulary];
                updatedVocabulary[originalIndex] = updatedCard;
                setAllVocabulary(updatedVocabulary);
                
                // Update session stats

                                    const difficultyMap = {
                        1: 'again',
                        3: 'hard', 
                        4: 'normal',
                        5: 'easy'
                    };
                    
                    setSessionStats(prev => ({
                        ...prev,
                        cardsStudied: prev.cardsStudied + 1,
                        [`${difficultyMap[difficulty]}Cards`]: prev[`${difficultyMap[difficulty]}Cards`] + 1,
                        newCards: !card.lastReviewed ? prev.newCards + 1 : prev.newCards,
                        reviewCards: card.lastReviewed ? prev.reviewCards + 1 : prev.reviewCards
                    }));
                    
                
                // Auto-save updated vocabulary
                setTimeout(() => {
                    saveToDatabase(updatedVocabulary);
                }, 500);
            };



            const loginUser = async (email, password) => {
    logger.trace('loginUser', { email });
    try {
        setIsLoading(true);
        setConnectionError(null);
        logger.info('Starting user login', { email });
        
        const { data, error } = await supabaseClient.auth.signInWithPassword({
            email: email,
            password: password
        });

        if (error) {
            logger.error('Login failed', { error: error.message, code: error.status });
            setConnectionError(`Login failed: ${error.message}`);
            return false;
        }

        logger.info('Login successful', { userId: data.user?.id, email: data.user?.email });
        return data.user;
    } catch (error) {
        logger.error('Login exception', { error: error.message, stack: error.stack });
        setConnectionError('Login failed. Please check your internet connection and try again.');
        return false;
    } finally {
        setIsLoading(false);
        logger.debug('Login process completed');
    }
};

            const registerUser = async (email, password, username) => {
    logger.trace('registerUser', { email, username });
    try {
        setIsLoading(true);
        setConnectionError(null);
        logger.info('Starting user registration', { email, username });
        
        const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password: password,
            options: {
                data: {
                    username: username
                }
            }
        });

        if (error) {
            logger.error('Registration failed', { error: error.message, code: error.status });
            setConnectionError(`Registration failed: ${error.message}`);
            return false;
        }

        logger.info('Registration successful', { userId: data.user?.id, email });
        alert('Registration successful! Please check your email to verify your account, then sign in.');
        return true;
    } catch (error) {
        logger.error('Registration exception', { error: error.message, stack: error.stack });
        setConnectionError('Registration failed. Please check your internet connection and try again.');
        return false;
    } finally {
        setIsLoading(false);
        logger.debug('Registration process completed');
    }
};

            const logoutUser = async () => {
                try {
                    await supabaseClient.auth.signOut();
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    setUserId('');
                    setAllVocabulary([]);
                    setEmail('');
                    setPassword('');
                    setCurrentScreen('login');
                    setLastSyncTime(null);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            const loadUserVocabulary = async (user) => {
    logger.trace('loadUserVocabulary', { userId: user?.id });
    try {
        setIsLoading(true);
        logger.info('Loading vocabulary for user', { userId: user.id, email: user.email });
        
        const { data, error } = await supabaseClient
            .from('user_vocabulary')
            .select('vocabulary, updated_at')
            .eq('user_id', user.id)
            .single();

        if (error) {
            logger.error('Error loading vocabulary', { 
                error: error.message, 
                code: error.code, 
                userId: user.id 
            });
            
            if (error.code === 'PGRST116') { 
                logger.info('No vocabulary found, creating initial record');
                await saveToDatabase([]);
                setAllVocabulary([]);
            } else if (error.code === '42501') {
                logger.error('Permission denied for vocabulary access');
                alert('Permission denied. Please check your account access.');
                setAllVocabulary([]);
            } else {
                logger.error('Database error during vocabulary load', { error: error.message });
                setAllVocabulary([]);
            }
            return;
        }

        if (data && data.vocabulary) {
            logger.info('Successfully loaded vocabulary', { 
                cardCount: data.vocabulary.length, 
                lastUpdate: data.updated_at 
            });
            setAllVocabulary(data.vocabulary || []);
            setLastSyncTime(new Date(data.updated_at));
        } else {
            logger.warn('No vocabulary data found');
            setAllVocabulary([]);
        }
    } catch (error) {
        logger.error('Exception during vocabulary load', { 
            error: error.message, 
            stack: error.stack 
        });
        setAllVocabulary([]);
    } finally {
        setIsLoading(false);
        logger.debug('Vocabulary loading completed');
    }
};
            const saveToDatabase = async (vocabulary) => {
    if (!currentUser || isSyncing) {
        logger.warn('Save blocked', { 
            hasUser: !!currentUser, 
            isSyncing, 
            vocabularyLength: vocabulary?.length 
        });
        return;
    }
    
    logger.trace('saveToDatabase', { userId: currentUser.id, cardCount: vocabulary.length });
    
    try {
        setIsSyncing(true);
        logger.info('Starting vocabulary save', { 
            userId: currentUser.id, 
            cardCount: vocabulary.length 
        });
        
        const { data, error } = await supabaseClient
            .from('user_vocabulary')
            .upsert({
                user_id: currentUser.id,
                vocabulary: vocabulary,
                updated_at: new Date().toISOString()
            }, {
                onConflict: 'user_id'
            });

        if (error) {
            logger.error('Save error', { 
                error: error.message, 
                code: error.code, 
                userId: currentUser.id 
            });
            
            if (error.code === '42501') {
                logger.error('Permission denied during save');
                alert('Permission denied. Please check your account permissions.');
            } else if (error.code === '23505') {
                logger.info('Conflict detected, trying update instead');
                const { error: updateError } = await supabaseClient
                    .from('user_vocabulary')
                    .update({
                        vocabulary: vocabulary,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id);
                    
                if (updateError) {
                    logger.error('Update also failed', { error: updateError.message });
                    alert('Failed to save vocabulary. Please try again.');
                } else {
                    setLastSyncTime(new Date());
                    logger.info('Successfully updated vocabulary via fallback');
                }
            } else {
                alert(`Failed to sync vocabulary: ${error.message}`);
            }
        } else {
            setLastSyncTime(new Date());
            logger.info('Successfully synced vocabulary', { cardCount: vocabulary.length });
        }
    } catch (error) {
        logger.error('Exception during save', { 
            error: error.message, 
            stack: error.stack 
        });
        alert('Sync failed due to network error. Please check your connection.');
    } finally {
        setTimeout(() => {
            setIsSyncing(false);
            logger.debug('Save process completed');
        }, 1000);
    }
};

            const submitFeedback = async () => {
    if (!feedbackText.trim()) {
        alert('Please enter your feedback before submitting.');
        return;
    }

    try {
        const { error } = await supabaseClient.from('user_feedback').insert([
            {
                user_id: currentUser.id,
                user_email: currentUser.email,
                username: currentUser.user_metadata.username || currentUser.email.split('@')[0],
                feedback_text: feedbackText.trim(),
                feedback_type: feedbackType,
                created_at: new Date().toISOString()
            }
        ]);

        if (error) {
            console.error('Feedback submission error:', error);
            alert('Failed to submit feedback. Please try again.');
        } else {
            alert('🎉 Thank you for your feedback!');
            setFeedbackText('');
            setFeedbackType('');
            setCurrentScreen('home');
        }
    } catch (error) {
        console.error('Unexpected error:', error);
        alert('Unexpected error. Please try again.');
    }
};


            const handleLogin = async (e) => {
                e.preventDefault();
                if (!email.trim() || !password.trim()) {
                    setConnectionError('Please enter both email and password');
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.trim())) {
                    setConnectionError('Please enter a valid email address');
                    return;
                }

                if (isRegistering) {
                    const usernameForRegistration = email.split('@')[0];
                    
                    const success = await registerUser(email.trim(), password, usernameForRegistration);
                    if (success) {
                        setIsRegistering(false);
                        setPassword('');
                    }
                } else {
                    const user = await loginUser(email.trim(), password);
                    if (user) {
                        setCurrentUser(user);
                        setUserId(user.id);
                        setIsLoggedIn(true);
                        setCurrentScreen('home');
                        await loadUserVocabulary(user);
                    }
                }
            };

            const handleLogout = () => {
                logoutUser();
            };

            // Study functions
            const startStudySession = () => {
    logger.trace('startStudySession');
    const maxNewCards = 20;
    const maxReviewCards = 100;
    
    const dueCards = getCardsForStudy(maxNewCards, maxReviewCards);
    
    logger.info('Study session analysis', {
        totalVocabulary: allVocabulary.length,
        dueCards: dueCards.length,
        maxNewCards,
        maxReviewCards
    });
    
    if (dueCards.length === 0) {
        logger.warn('No cards due for study');
        alert('No cards are due for review right now! Come back later or add more cards.');
        return;
    }
    
    logger.info('Starting study session', { cardCount: dueCards.length });
    
    setStudyCards(dueCards);
    setCurrentCardIndex(0);
    setShowAnswer(false);
    setSessionStats({
        cardsStudied: 0,
        newCards: 0,
        reviewCards: 0,
        againCards: 0,
        easyCards: 0,
        normalCards: 0,
        hardCards: 0
    });
    setCurrentScreen('study');
};
            const handleAnswer = (grade) => {
    updateCardProgress(currentCardIndex, grade);
    
    setTimeout(() => {
        const updatedStudyCards = studyCards.filter((_, index) => index !== currentCardIndex);
        setStudyCards(updatedStudyCards);
        
        if (updatedStudyCards.length === 0) {
            setCurrentScreen('results');
        } else {
            if (currentCardIndex >= updatedStudyCards.length) {
                setCurrentCardIndex(0);
            }
            setShowAnswer(false);
        }
    }, 500);
};

            // Smart word selection function
const getSmartActiveRecallCards = (mode, maxCards = 20) => {
    const now = new Date();
    
    // Get cards with performance data
    const cardsWithPerformance = allVocabulary.map(card => {
        const performance = card.activeRecallPerformance || {
            attempts: 0,
            correct: 0,
            accuracy: 0,
            lastAttempt: null
        };
        
        // Calculate priority score (higher = more likely to appear)
        let priority = 1;
        
        // Prioritize words with low accuracy
        if (performance.attempts > 0) {
            const accuracy = performance.correct / performance.attempts;
            priority = Math.max(0.1, 1 - accuracy); // Lower accuracy = higher priority
        }
        
        // Boost priority for due cards
        const isDue = !card.nextReviewDate || new Date(card.nextReviewDate) <= now;
        if (isDue) priority *= 2;
        
        // Boost priority for new cards
        if (!card.lastReviewed) priority *= 1.5;
        
        // Boost priority for recently wrong cards
        if (difficultWords.has(card.czech + '|' + card.english)) {
            priority *= 3;
        }
        
        return { ...card, priority, performance };
    });
    
    // Weighted random selection
    const selectedCards = [];
    const availableCards = [...cardsWithPerformance];
    
    for (let i = 0; i < Math.min(maxCards, availableCards.length); i++) {
        // Calculate total weight
        const totalWeight = availableCards.reduce((sum, card) => sum + card.priority, 0);
        
        // Random selection based on weight
        let random = Math.random() * totalWeight;
        let selectedIndex = 0;
        
        for (let j = 0; j < availableCards.length; j++) {
            random -= availableCards[j].priority;
            if (random <= 0) {
                selectedIndex = j;
                break;
            }
        }
        
        selectedCards.push(availableCards[selectedIndex]);
        availableCards.splice(selectedIndex, 1);
    }
    
    // Add session wrong cards to the end for repetition
    const wrongCardsToRepeat = sessionWrongCards.filter(wrongCard => 
        !selectedCards.some(card => card.czech === wrongCard.czech && card.english === wrongCard.english)
    );
    
    return [...selectedCards, ...wrongCardsToRepeat];
};

// Enhanced typing recall game starter
const startTypingRecallGame = (mode) => {
    const smartCards = getSmartActiveRecallCards(mode, 20);
    setTypingGameCards(smartCards);
    setTypingCurrentIndex(0);
    setUserInput('');
    setShowFeedback(false);
    setTypingRecallMode(mode);
    setActiveRecallStats(prev => ({
        ...prev,
        sessionCorrect: 0,
        sessionTotal: 0
    }));
    setSessionWrongCards([]);
    setCurrentScreen('typingRecall');
};

// Performance tracking function
const updateActiveRecallPerformance = (card, correct) => {
    const cardIndex = allVocabulary.findIndex(c => 
        c.czech === card.czech && c.english === card.english
    );
    
    if (cardIndex === -1) return;
    
    const updatedCard = { ...allVocabulary[cardIndex] };
    
    if (!updatedCard.activeRecallPerformance) {
        updatedCard.activeRecallPerformance = {
            attempts: 0,
            correct: 0,
            accuracy: 0,
            lastAttempt: null
        };
    }
    
    updatedCard.activeRecallPerformance.attempts += 1;
    updatedCard.activeRecallPerformance.correct += correct ? 1 : 0;
    updatedCard.activeRecallPerformance.accuracy = 
        updatedCard.activeRecallPerformance.correct / updatedCard.activeRecallPerformance.attempts;
    updatedCard.activeRecallPerformance.lastAttempt = new Date().toISOString();
    
    const updatedVocabulary = [...allVocabulary];
    updatedVocabulary[cardIndex] = updatedCard;
    setAllVocabulary(updatedVocabulary);
    
    // Auto-save
    setTimeout(() => {
        saveToDatabase(updatedVocabulary);
    }, 500);
};

// Enhanced answer checking
const checkTypingAnswer = () => {
    const currentTypingCard = typingGameCards[typingCurrentIndex];
    const correctAnswer = typingRecallMode === 'czech-to-english' 
        ? currentTypingCard.english.toLowerCase().trim()
        : currentTypingCard.czech.toLowerCase().trim();
    const userAnswer = userInput.toLowerCase().trim();
    const correct = correctAnswer === userAnswer;
    
    setIsCorrect(correct);
    setShowFeedback(true);
    
    // Update performance tracking
    updateActiveRecallPerformance(currentTypingCard, correct);
    
    // Update session stats
    setActiveRecallStats(prev => ({
        totalAttempts: prev.totalAttempts + 1,
        correctAnswers: prev.correctAnswers + (correct ? 1 : 0),
        sessionCorrect: prev.sessionCorrect + (correct ? 1 : 0),
        sessionTotal: prev.sessionTotal + 1
    }));
    
    // Track difficult words
    if (!correct) {
        const cardKey = currentTypingCard.czech + '|' + currentTypingCard.english;
        setDifficultWords(prev => new Set([...prev, cardKey]));
        setSessionWrongCards(prev => {
            // Only add if not already in the list
            const exists = prev.some(card => 
                card.czech === currentTypingCard.czech && card.english === currentTypingCard.english
            );
            return exists ? prev : [...prev, currentTypingCard];
        });
    }
};

            const addManualCard = (czech, english) => {
                if (!czech.trim() || !english.trim()) {
                    alert('Please fill in both Czech and English fields');
                    return;
                }
                
                const newCard = {
                    czech: czech.trim(),
                    english: english.trim(),
                    consecutiveCorrect: 0,
                    easeFactor: 2.5,
                    interval: 1,
                    nextReviewDate: new Date().toISOString(),
                    lastReviewed: null
                };
                
                const updatedVocabulary = [...allVocabulary, newCard];
                setAllVocabulary(updatedVocabulary);
                setManualCzech('');
                setManualEnglish('');
                alert('Card added successfully!');
                
                setTimeout(() => {
                    saveToDatabase(updatedVocabulary);
                }, 500);
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                addManualCard(manualCzech, manualEnglish);
            };

            // CSV processing functions
            const handleCsvUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert('Please upload a CSV file');
                    return;
                }

                setIsProcessingCsv(true);
                setCurrentScreen('csvProcessing');

                try {
                    const text = await file.text();
                    parseCsvText(text);
                } catch (error) {
                    console.error('Error reading CSV file:', error);
                    alert('Error reading CSV file. Please try again.');
                    setCurrentScreen('home');
                }

                setIsProcessingCsv(false);
            };

            const parseCsvText = (csvText) => {
    logger.trace('parseCsvText', { textLength: csvText.length });
    
    const lines = csvText.split('\n').filter(line => line.trim());
    const parsed = [];
    const validationRes = [];
    
    logger.info('Processing CSV', { totalLines: lines.length });

    lines.forEach((line, index) => {
        if (index === 0 && (line.toLowerCase().includes('czech') || line.toLowerCase().includes('english'))) {
            logger.debug('Skipping header line', { line });
            return;
        }

        let parts = [];
        if (line.includes(',')) {
            parts = line.split(',');
        } else if (line.includes(';')) {
            parts = line.split(';');
        } else if (line.includes('\t')) {
            parts = line.split('\t');
        }

        if (parts.length >= 2 && parsed.length < 300) {
            let czech = parts[0].trim().replace(/^["'](.*)["']$/, '$1');
            let english = parts[1].trim().replace(/^["'](.*)["']$/, '$1');

            if (czech.length >= 2 && english.length >= 2) {
                const validation = validateCardPair(czech, english);
                parsed.push({ czech, english, id: index });
                validationRes.push(validation);
                logger.debug('Found CSV pair', { index, czech, english, isValid: validation.isValid });
            }
        }
    });

    logger.info('CSV parsing completed', { 
        parsedCount: parsed.length, 
        validCount: validationRes.filter(v => v.isValid).length 
    });
    
    setCsvCards(parsed);
    setCsvValidationResults(validationRes);
    
    if (parsed.length === 0) {
        logger.warn('No valid vocabulary pairs found in CSV');
        alert(`No vocabulary pairs found in CSV. Make sure your CSV has this format:\n\nczech_word,english_word\ndobrý den,good day\nděkuji,thank you`);
    }
};

            const addCsvCardsToVocabulary = () => {
                const validCards = csvCards.filter((card, index) => {
                    const validation = csvValidationResults[index];
                    return !validation || validation.isValid || card.manuallyApproved;
                }).map(card => ({
                    ...card,
                    consecutiveCorrect: 0,
                    easeFactor: 2.5,
                    interval: 1,
                    nextReviewDate: new Date().toISOString(),
                    lastReviewed: null
                }));
                
                const updatedVocabulary = [...allVocabulary, ...validCards];
                setAllVocabulary(updatedVocabulary);
                setCsvCards([]);
                setCsvValidationResults([]);
                setCurrentScreen('home');
                alert(`Added ${validCards.length} new cards from CSV to your vocabulary!`);
                
                setTimeout(() => {
                    saveToDatabase(updatedVocabulary);
                }, 500);
            };

            const approveCsvCard = (index) => {
                const updated = [...csvCards];
                updated[index].manuallyApproved = true;
                setCsvCards(updated);
            };

            const editCsvCard = (index, field, value) => {
                const updated = [...csvCards];
                updated[index][field] = value;
                setCsvCards(updated);
            };

            const removeCsvCard = (index) => {
                const updated = csvCards.filter((_, i) => i !== index);
                setCsvCards(updated);
            };

            const forceSync = async () => {
                if (!isSyncing) {
                    await saveToDatabase(allVocabulary);
                }
            };
            
            const validateCzechWord = (word) => {
                const cleanWord = word.toLowerCase().trim();
                const czechChars = ['č', 'š', 'ž', 'ř', 'ď', 'ť', 'ň', 'ů', 'á', 'é', 'í', 'ó', 'ú', 'ý'];
                const hasCzechChars = czechChars.some(char => cleanWord.includes(char));
                return hasCzechChars || cleanWord.length >= 3;
            };

            const validateEnglishWord = (word) => {
                const cleanWord = word.toLowerCase().trim();
                const englishPattern = /^[a-z\s\-'\.]+$/i;
                return englishPattern.test(cleanWord) && cleanWord.length >= 1;
            };

            const validateCardPair = (czech, english) => {
                const czechValid = validateCzechWord(czech);
                const englishValid = validateEnglishWord(english);
                
                return {
                    isValid: czechValid && englishValid,
                    czechValid,
                    englishValid,
                    issues: [
                        ...(!czechValid ? ['Czech word might be incorrect'] : []),
                        ...(!englishValid ? ['English word might be incorrect'] : [])
                    ]
                };
            };

            // Initialize app and check for existing session
            useEffect(() => {
                const checkSession = async () => {
                    try {
                        console.log('Starting session check...');
                        setIsLoading(true);
                        
                        const sessionPromise = supabaseClient.auth.getSession();
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Session check timeout')), 10000)
                        );
                        
                        const { data: { session }, error } = await Promise.race([sessionPromise, timeoutPromise]);
                        
                        if (error) {
                            console.error('Session check error:', error);
                            setCurrentScreen('login');
                            return;
                        }
                        
                        if (session?.user) {
                            console.log('Found existing session for user:', session.user.email);
                            setCurrentUser(session.user);
                            setUserId(session.user.id);
                            setEmail(session.user.email);
                            setIsLoggedIn(true);
                            setCurrentScreen('home');
                            await loadUserVocabulary(session.user);
                        } else {
                            console.log('No existing session found');
                            setCurrentScreen('login');
                        }
                    } catch (error) {
                        console.error('Session check failed:', error);
                        setCurrentScreen('login');
                        setConnectionError('Connection failed. Please check your internet connection.');
                    } finally {
                        setIsLoading(false);
                    }
                };

                const timer = setTimeout(checkSession, 500);

                const { data: subscription } = supabaseClient.auth.onAuthStateChange(
                    async (event, session) => {
                        console.log('Auth state change:', event, session?.user?.email);
                        
                        if (event === 'SIGNED_IN' && session?.user) {
                            setCurrentUser(session.user);
                            setUserId(session.user.id);
                            setEmail(session.user.email);
                            setIsLoggedIn(true);
                            setCurrentScreen('home');
                            setConnectionError(null);
                        } else if (event === 'SIGNED_OUT') {
                            setCurrentUser(null);
                            setUserId('');
                            setEmail('');
                            setIsLoggedIn(false);
                            setCurrentScreen('login');
                            setAllVocabulary([]);
                            setLastSyncTime(null);
                        } else if (event === 'TOKEN_REFRESHED') {
                            console.log('Token refreshed successfully');
                        }
                    }
                );

                return () => {
                    clearTimeout(timer);
                    subscription?.unsubscribe();
                };
            }, []);

            useEffect(() => {
                if (allVocabulary.length > 0 && !isLoading && currentUser && isLoggedIn && !isSyncing) {
                    const timeoutId = setTimeout(() => {
                        saveToDatabase(allVocabulary);
                    }, 3000);

                    return () => clearTimeout(timeoutId);
                }
            }, [allVocabulary, currentUser?.id]);

            const currentCard = studyCards[currentCardIndex];

            // Helper function to get due cards count
            const getDueCardsCount = () => {
    const maxNewCards = 20;
    const maxReviewCards = 100;
    const dueCards = getCardsForStudy(maxNewCards, maxReviewCards);
    return dueCards.length;
};

            // Helper function to calculate next interval for display
           const getNextInterval = (card, grade) => {
    if (!card) return 1;
    
    const interval = card.interval || 1;
    const easeFactor = card.easeFactor || 2.5;
    const repetitions = card.repetitions || 0;

    if (grade < 3) {
        return 1; // Fail → reset to 1 day
    } else {
        if (repetitions + 1 === 1) {
            return 1; // First success → 1 day
        } else if (repetitions + 1 === 2) {
            return 6; // Second success → 6 days
        } else {
            let nextInterval = Math.round(interval * easeFactor);
            
            // Apply grade modifiers
            if (grade === 3) { // Hard
                nextInterval = Math.round(nextInterval * 0.8);
            } else if (grade === 5) { // Easy
                nextInterval = Math.round(nextInterval * 1.3);
            }
            
            return nextInterval;
        }
    }
};

            // Login Screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">🇨🇿</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Czech Flashcards</h1>
                                <p className="text-gray-600">
                                    {isRegistering ? 'Create your account' : 'Sign in to your account'}
                                </p>
                            </div>

                            {connectionError && (
                                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <div className="text-red-800 text-sm">{connectionError}</div>
                                </div>
                            )}

                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="Enter your email address"
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Enter your password"
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                                        required
                                        minLength="6"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-full bg-blue-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                                >
                                    {isLoading ? 'Processing...' : (isRegistering ? 'Create Account' : 'Sign In')}
                                </button>
                            </form>

                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsRegistering(!isRegistering);
                                        setPassword('');
                                        setConnectionError(null);
                                    }}
                                    className="text-blue-600 hover:text-blue-700 underline"
                                >
                                    {isRegistering ? 'Already have an account? Sign in' : 'Need an account? Register'}
                                </button>
                            </div>

                            <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-semibold text-blue-800 mb-2">🌟 Features:</h3>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li>• Spaced repetition algorithm (Anki-style)</li>
                                    <li>• Easy/Normal/Hard difficulty options</li>
                                    <li>• Cloud sync across devices</li>
                                    <li>• Add cards manually or from CSV</li>
                                </ul>
                            </div>

                            <div className="mt-6 text-center">
                                <div className="text-xs text-gray-500">
                                    🌐 Your account works on any device • 🔒 Secure authentication
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Loading Screen
            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md">
                            <div className="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Connecting...</h2>
                            <p className="text-gray-600 mb-4">Checking your login status</p>
                            
                            <button
                                onClick={() => {
                                    setIsLoading(false);
                                    setCurrentScreen('login');
                                    setConnectionError('Connection timeout. Please try logging in manually.');
                                }}
                                className="text-blue-600 hover:text-blue-700 underline text-sm"
                            >
                                Skip to login
                            </button>
                            
                            <div className="mt-4 text-xs text-gray-500">
                                If this takes too long, click "Skip to login"
                            </div>
                        </div>
                    </div>
                );
            }

            // Home Screen
if (currentScreen === 'home') {
    const dueCards = getDueCardsCount();
    const newCardsCount = allVocabulary.filter(card => !card.lastReviewed).length;
    const reviewCardsCount = allVocabulary.filter(card => card.lastReviewed && new Date(card.nextReviewDate) <= new Date()).length;
    
    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
            <div className="max-w-md mx-auto">
                <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                    <div className="flex justify-between items-center mb-6">
                        <div className="text-left">
                            <div className="text-sm text-gray-500">Welcome back,</div>
                            <div className="font-semibold text-gray-800">
                                {currentUser?.user_metadata?.username || currentUser?.email?.split('@')[0]}
                            </div>
                        </div>
                        <button
                            onClick={handleLogout}
                            className="text-sm text-red-600 hover:text-red-700 underline"
                        >
                            Logout
                        </button>
                    </div>

                    <div className="text-6xl mb-6">🇨🇿</div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-4">Czech Vocabulary</h1>
                    <p className="text-gray-600 mb-8">Spaced repetition learning system</p>
                    
                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-blue-50 p-4 rounded-xl">
                            <div className="text-2xl font-bold text-blue-600">{allVocabulary.length}</div>
                            <div className="text-sm text-gray-600">Total Cards</div>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-xl">
                            <div className="text-2xl font-bold text-orange-600">{dueCards}</div>
                            <div className="text-sm text-gray-600">Due Today</div>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-green-50 p-4 rounded-xl">
                            <div className="text-xl font-bold text-green-600">{newCardsCount}</div>
                            <div className="text-sm text-gray-600">New</div>
                        </div>
                        <div className="bg-purple-50 p-4 rounded-xl">
                            <div className="text-xl font-bold text-purple-600">{reviewCardsCount}</div>
                            <div className="text-sm text-gray-600">Review</div>
                        </div>
                    </div>

                    {allVocabulary.length === 0 && !isSyncing && (
                        <button
                            onClick={() => loadUserVocabulary(currentUser)}
                            className="w-full bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold mb-4 hover:bg-blue-700 transition-colors"
                        >
                            Load My Vocabulary
                        </button>
                    )}

                    <div className="mb-6 p-3 bg-gray-50 rounded-lg">
                        <div className="flex justify-between items-center">
                            <div className="text-sm text-gray-600">
                                {isSyncing ? (
                                    <span className="flex items-center">
                                        <div className="animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full mr-2"></div>
                                        Syncing...
                                    </span>
                                ) : (
                                    <span className="flex items-center">
                                        <div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                        {lastSyncTime ? `Synced ${lastSyncTime.toLocaleTimeString()}` : 'Ready to sync'}
                                    </span>
                                )}
                            </div>
                            <button
                                onClick={forceSync}
                                disabled={isSyncing}
                                className="text-blue-600 hover:text-blue-700 text-sm underline disabled:opacity-50"
                            >
                                Sync
                            </button>
                        </div>
                    </div>

{allVocabulary.length === 0 ? (
    <div className="mb-6">
        <div className="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div className="text-yellow-800 font-semibold mb-2">🚀 Get Started!</div>
            <div className="text-sm text-yellow-700">
                Your vocabulary is empty. Add your first cards using the button below!
            </div>
        </div>

        {/* Add Cards Block - Always visible when empty */}
        <div 
            onClick={() => setCurrentScreen('addCardsMenu')}
            className="bg-gradient-to-br from-green-500 to-teal-500 rounded-xl p-6 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl mb-4"
        >
            <div className="flex items-center justify-between">
                <div>
                    <div className="text-2xl font-bold mb-1">Add Your First Cards</div>
                    <div className="text-sm opacity-90">Manual entry or CSV import</div>
                </div>
                <div className="text-4xl">➕</div>
            </div>
        </div>
    </div>
) : dueCards > 0 ? (
    // ... rest of the existing grid code
    <div className="mb-6">
        <div className="grid grid-cols-2 gap-4 mb-4">
            {/* Study Block */}
            <div 
                onClick={startStudySession}
                className="bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
            >
                <div className="text-3xl mb-2">🧠</div>
                <div className="font-bold text-lg mb-1">Study</div>
                <div className="text-xs opacity-80">{dueCards} cards due</div>
            </div>

            {/* Active Recall Block */}
            <div 
                onClick={() => setCurrentScreen('activeRecallMenu')}
                className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
            >
                <div className="text-3xl mb-2">⚡</div>
                <div className="font-bold text-lg mb-1">Active Recall</div>
                <div className="text-xs opacity-80">Smart practice</div>
            </div>

            {/* Browse Block */}
            {allVocabulary.length > 0 && (
                <div 
                    onClick={() => setCurrentScreen('browse')}
                    className="bg-gradient-to-br from-cyan-400 to-blue-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
                >
                    <div className="text-3xl mb-2">📚</div>
                    <div className="font-bold text-lg mb-1">Browse</div>
                    <div className="text-xs opacity-80">{allVocabulary.length} cards</div>
                </div>
            )}

            {/* Add Cards Block */}
<div 
    onClick={() => setCurrentScreen('addCardsMenu')}
    className="bg-gradient-to-br from-green-500 to-teal-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
>
    <div className="text-3xl mb-2">➕</div>
    <div className="font-bold text-lg mb-1">Add Cards</div>
    <div className="text-xs opacity-80">Manual or CSV import</div>
</div>
            {/* Feedback Block */}
<div 
    onClick={() => setCurrentScreen('feedback')}
    className="bg-gradient-to-br from-pink-500 to-red-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
>
    <div className="text-3xl mb-2">📝</div>
    <div className="font-bold text-lg mb-1">Give Feedback</div>
    <div className="text-xs opacity-80">Help us improve</div>
</div>

        </div>
    </div>
) : (
    <div className="mb-6">
        <div className="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div className="text-green-800 font-semibold mb-2">🎉 All caught up!</div>
            <div className="text-sm text-green-700">
                No cards are due for review right now. Come back later or add more cards!
            </div>
        </div>

        <div className="grid grid-cols-2 gap-4 mb-4">
            {/* Browse Block */}
            {allVocabulary.length > 0 && (
                <div 
                    onClick={() => setCurrentScreen('browse')}
                    className="bg-gradient-to-br from-cyan-400 to-blue-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
                >
                    <div className="text-3xl mb-2">📚</div>
                    <div className="font-bold text-lg mb-1">Browse</div>
                    <div className="text-xs opacity-80">{allVocabulary.length} cards</div>
                </div>
            )}

            {/* Add Cards Block */}
            <div 
                onClick={() => setCurrentScreen('manualAdd')}
                className="bg-gradient-to-br from-green-500 to-teal-500 rounded-xl p-4 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
            >
                <div className="text-3xl mb-2">➕</div>
                <div className="font-bold text-lg mb-1">Add Cards</div>
                <div className="text-xs opacity-80">Manual entry</div>
            </div>
        </div>
    </div>
)}

                    
                </div>
            </div>
        </div>
    );
}

            // Manual Add Screen
            if (currentScreen === 'manualAdd') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <div className="flex items-center mb-6">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-2xl font-bold text-gray-800">Add New Card</h2>
                                </div>

                                <form onSubmit={handleManualSubmit} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Czech Word
                                        </label>
                                        <input
                                            type="text"
                                            value={manualCzech}
                                            onChange={(e) => setManualCzech(e.target.value)}
                                            placeholder="Enter Czech word..."
                                            className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            English Word
                                        </label>
                                        <input
                                            type="text"
                                            value={manualEnglish}
                                            onChange={(e) => setManualEnglish(e.target.value)}
                                            placeholder="Enter English word..."
                                            className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                                            required
                                        />
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            type="submit"
                                            className="flex-1 bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors"
                                        >
                                            Add Card
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setCurrentScreen('home')}
                                            className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            // Browse Screen
            if (currentScreen === 'browse') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl">
                                <div className="flex items-center p-6 border-b">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-xl font-semibold">All Vocabulary ({allVocabulary.length} cards)</h2>
                                </div>
                                
                                <div className="max-h-96 overflow-y-auto">
                                    {allVocabulary.map((card, index) => {
                                        const isNew = !card.lastReviewed;
                                        const isDue = card.nextReviewDate && new Date(card.nextReviewDate) <= new Date();
                                        
                                        return (
                                            <div key={index} className="flex justify-between items-center p-4 border-b last:border-b-0 hover:bg-gray-50">
                                                <div className="flex flex-col">
                                                    <span className="font-bold text-lg text-red-600">{card.czech}</span>
                                                    <span className="text-gray-600">{card.english}</span>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        {isNew ? (
                                                            <span className="text-green-600 font-semibold">NEW</span>
                                                        ) : (
                                                            <span>
                                                                Ease: {((card.easeFactor || 2.5) * 100).toFixed(0)}% • 
                                                                Interval: {card.interval || 1}d • 
                                                                Streak: {card.consecutiveCorrect || 0}
                                                                {isDue && <span className="text-orange-600 font-semibold ml-2">DUE</span>}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Study Screen with Easy/Normal/Hard buttons
            if (currentScreen === 'study') {
                if (!currentCard) return <div>Loading...</div>;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="flex items-center justify-between mb-6">
                                <button
                                    onClick={() => setCurrentScreen('home')}
                                    className="p-3 text-white hover:bg-white hover:bg-opacity-20 rounded-full"
                                >
                                    Home
                                </button>
                                <div className="text-white bg-black bg-opacity-20 px-4 py-2 rounded-full font-semibold">
                                    {studyCards.length} cards left
                                </div>
                                <button
                                    onClick={() => {
                                        const dueCards = getCardsForStudy();
                                        setStudyCards(dueCards);
                                        setCurrentCardIndex(0);
                                        setShowAnswer(false);
                                    }}
                                    className="p-3 text-white hover:bg-white hover:bg-opacity-20 rounded-full"
                                >
                                    Reset
                                </button>
                            </div>

                            <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6 min-h-64 flex flex-col justify-center items-center text-center">
                                <div className="text-4xl font-bold text-red-600 mb-6">
                                    {currentCard.czech}
                                </div>
                                
                                {showAnswer && (
                                    <div className="text-2xl text-green-600 border-t-2 border-gray-200 pt-6 mt-6 w-full">
                                        {currentCard.english}
                                    </div>
                                )}
                                
                                {showAnswer && (
                                    <div className="mt-4 text-sm text-gray-500">
                                        {currentCard.lastReviewed ? (
                                            <div>
                                                <div>Current interval: {currentCard.interval || 1} days</div>
                                                <div>Ease factor: {((currentCard.easeFactor || 2.5) * 100).toFixed(0)}%</div>
                                                <div>Consecutive correct: {currentCard.consecutiveCorrect || 0}</div>
                                            </div>
                                        ) : (
                                            <div className="text-blue-600 font-semibold">NEW CARD</div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {!showAnswer ? (
                                <button
                                    onClick={() => setShowAnswer(true)}
                                    className="w-full bg-yellow-500 text-white py-4 px-6 rounded-xl font-bold text-xl hover:bg-yellow-600 transition-colors"
                                >
                                    Show Answer
                                </button>
                            ) : (
                                <div className="space-y-3">
    <button
        onClick={() => handleAnswer(1)}
        className="w-full bg-red-500 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-red-600 transition-colors"
    >
        Again ({getNextInterval(currentCard, 1)}d)
    </button>
    <button
        onClick={() => handleAnswer(3)}
        className="w-full bg-orange-500 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-orange-600 transition-colors"
    >
        Hard ({getNextInterval(currentCard, 3)}d)
    </button>
    <button
        onClick={() => handleAnswer(4)}
        className="w-full bg-green-500 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-green-600 transition-colors"
    >
        Good ({getNextInterval(currentCard, 4)}d)
    </button>
    <button
        onClick={() => handleAnswer(5)}
        className="w-full bg-blue-500 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-blue-600 transition-colors"
    >
        Easy ({getNextInterval(currentCard, 5)}d)
    </button>
</div>
                            )}
                        </div>
                    </div>
                );
            }
if (currentScreen === 'activeRecallMenu') {
    const totalAccuracy = activeRecallStats.totalAttempts > 0 
        ? Math.round((activeRecallStats.correctAnswers / activeRecallStats.totalAttempts) * 100)
        : 0;
    
    const sessionAccuracy = activeRecallStats.sessionTotal > 0
        ? Math.round((activeRecallStats.sessionCorrect / activeRecallStats.sessionTotal) * 100)
        : 0;
    
    // Get words that need practice
    const wordsNeedingPractice = allVocabulary
        .filter(card => {
            const perf = card.activeRecallPerformance;
            return perf && perf.attempts >= 3 && perf.accuracy < 0.7;
        })
        .sort((a, b) => a.activeRecallPerformance.accuracy - b.activeRecallPerformance.accuracy)
        .slice(0, 5);
    
    return (
        <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 p-4 flex items-center justify-center">
            <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full">
                <h2 className="text-3xl font-bold mb-6">🧠 Smart Active Recall</h2>
                
                {/* Performance Stats */}
                <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="bg-blue-50 p-4 rounded-xl">
                        <div className="text-2xl font-bold text-blue-600">{totalAccuracy}%</div>
                        <div className="text-sm text-gray-600">Overall Accuracy</div>
                    </div>
                    <div className="bg-green-50 p-4 rounded-xl">
                        <div className="text-2xl font-bold text-green-600">{sessionAccuracy}%</div>
                        <div className="text-sm text-gray-600">Session Accuracy</div>
                    </div>
                </div>
                
                {/* Session stats */}
                {activeRecallStats.sessionTotal > 0 && (
                    <div className="mb-6 p-3 bg-gray-50 rounded-lg">
                        <div className="text-sm text-gray-600">
                            This session: {activeRecallStats.sessionCorrect}/{activeRecallStats.sessionTotal} correct
                        </div>
                    </div>
                )}
                
                {/* Words needing practice */}
                {wordsNeedingPractice.length > 0 && (
                    <div className="mb-6 p-3 bg-yellow-50 rounded-lg">
                        <div className="text-sm font-semibold text-yellow-800 mb-2">
                            Words needing practice:
                        </div>
                        <div className="text-xs text-yellow-700">
                            {wordsNeedingPractice.map(card => card.czech).join(', ')}
                        </div>
                    </div>
                )}
                
                <div className="space-y-4">
                    <button
                        onClick={() => startTypingRecallGame('czech-to-english')}
                        className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-purple-700 transition-colors"
                    >
                        Type English Word
                        <div className="text-sm opacity-80">Smart selection based on difficulty</div>
                    </button>
                    <button
                        onClick={() => startTypingRecallGame('english-to-czech')}
                        className="w-full bg-indigo-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-indigo-700 transition-colors"
                    >
                        Type Czech Word
                        <div className="text-sm opacity-80">Focuses on your weak points</div>
                    </button>
                    <button
                        onClick={() => setCurrentScreen('home')}
                        className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors mt-4"
                    >
                        ← Back to Home
                    </button>
                </div>
            </div>
        </div>
    );
}

          if (currentScreen === 'typingRecall') {
    const currentTypingCard = typingGameCards[typingCurrentIndex];

    if (!currentTypingCard) {
        const sessionAccuracy = activeRecallStats.sessionTotal > 0
            ? Math.round((activeRecallStats.sessionCorrect / activeRecallStats.sessionTotal) * 100)
            : 0;
            
        return (
            <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 p-4 flex items-center justify-center">
                <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md">
                    <h2 className="text-3xl font-bold mb-4">🎉 Session Complete!</h2>
                    
                    <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div className="text-2xl font-bold text-blue-600">{sessionAccuracy}%</div>
                        <div className="text-sm text-gray-600">Session Accuracy</div>
                        <div className="text-xs text-gray-500 mt-1">
                            {activeRecallStats.sessionCorrect}/{activeRecallStats.sessionTotal} correct
                        </div>
                    </div>
                    
                    {sessionWrongCards.length > 0 && (
                        <div className="mb-4 p-3 bg-yellow-50 rounded-lg">
                            <div className="text-sm font-semibold text-yellow-800 mb-2">
                                Words to review:
                            </div>
                            <div className="text-xs text-yellow-700">
                                {sessionWrongCards.slice(0, 3).map(card => card.czech).join(', ')}
                                {sessionWrongCards.length > 3 && '...'}
                            </div>
                        </div>
                    )}
                    
                    <div className="space-y-3">
                        <button
                            onClick={() => startTypingRecallGame(typingRecallMode)}
                            className="w-full bg-purple-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-purple-700 transition-colors"
                        >
                            Practice Again
                        </button>
                        <button
                            onClick={() => setCurrentScreen('activeRecallMenu')}
                            className="w-full bg-blue-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                        >
                            Back to Active Recall
                        </button>
                        <button
                            onClick={() => setCurrentScreen('home')}
                            className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                        >
                            Home
                        </button>
                    </div>
                </div>
            </div>
        );
    }

    const cardPerformance = currentTypingCard.activeRecallPerformance;
    const showPerformance = cardPerformance && cardPerformance.attempts > 0;

    return (
        <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 p-4 flex flex-col items-center justify-center">
            {/* Header with progress and stats */}
            <div className="w-full max-w-md flex justify-between items-center mb-4">
                <button
                    onClick={() => setCurrentScreen('activeRecallMenu')}
                    className="text-white bg-black bg-opacity-30 px-4 py-2 rounded-full hover:bg-opacity-50 transition"
                >
                    ← Back
                </button>
                <div className="text-white bg-black bg-opacity-30 px-4 py-2 rounded-full">
                    {typingCurrentIndex + 1}/{typingGameCards.length}
                </div>
                <div className="text-white bg-black bg-opacity-30 px-4 py-2 rounded-full">
                    {activeRecallStats.sessionTotal > 0 ? 
                        `${Math.round((activeRecallStats.sessionCorrect / activeRecallStats.sessionTotal) * 100)}%` 
                        : '0%'}
                </div>
            </div>

            <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full">
                <div className="text-4xl font-bold text-red-600 mb-6">
                    {typingRecallMode === 'czech-to-english' 
                        ? currentTypingCard.czech 
                        : currentTypingCard.english}
                </div>

                {/* Show card performance if available */}
                {showPerformance && (
                    <div className="mb-4 p-2 bg-gray-50 rounded text-xs text-gray-600">
                        Your accuracy: {Math.round(cardPerformance.accuracy * 100)}% 
                        ({cardPerformance.correct}/{cardPerformance.attempts})
                    </div>
                )}

                <input
                    type="text"
                    value={userInput}
                    onChange={(e) => setUserInput(e.target.value)}
                    onKeyPress={(e) => {
                        if (e.key === 'Enter' && !showFeedback) {
                            checkTypingAnswer();
                        }
                    }}
                    placeholder="Type your answer"
                    className="w-full p-4 mb-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg"
                    autoFocus
                />

                <>
                    {!showFeedback && (
                        <button
                            onClick={checkTypingAnswer}
                            className="w-full bg-blue-600 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-blue-700 transition-colors"
                        >
                            Check Answer
                        </button>
                    )}

                    {showFeedback && (
                        <div className="mt-6">
                            {isCorrect ? (
                                <div className="text-green-600 font-bold text-xl mb-4">✅ Correct!</div>
                            ) : (
                                <div className="text-red-600 font-bold text-xl mb-4">
                                    ❌ Wrong! 
                                    <div className="text-lg mt-2">
                                        Correct: {typingRecallMode === 'czech-to-english' 
                                            ? currentTypingCard.english 
                                            : currentTypingCard.czech}
                                    </div>
                                </div>
                            )}

                            <button
                                onClick={() => {
                                    setUserInput('');
                                    setShowFeedback(false);
                                    setTypingCurrentIndex(typingCurrentIndex + 1);
                                }}
                                className="w-full bg-green-600 text-white py-3 px-6 rounded-xl font-bold text-lg hover:bg-green-700 transition-colors"
                            >
                                Next Card
                            </button>
                        </div>
                    )}
                </>
            </div>
        </div>
    );
}


            // Results Screen
            if (currentScreen === 'results') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <div className="text-6xl mb-6">🎉</div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-8">Session Complete!</h2>
                                
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <div className="bg-blue-50 p-4 rounded-xl">
                                        <div className="text-2xl font-bold text-blue-600">{sessionStats.cardsStudied}</div>
                                        <div className="text-sm text-gray-600">Cards Studied</div>
                                    </div>
                                    <div className="bg-green-50 p-4 rounded-xl">
                                        <div className="text-2xl font-bold text-green-600">{sessionStats.newCards}</div>
                                        <div className="text-sm text-gray-600">New Cards</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-4 gap-2 mb-8">
                                    <div className="bg-red-50 p-3 rounded-lg">
                                        <div className="text-lg font-bold text-red-600">{sessionStats.againCards}</div>
                                        <div className="text-xs text-gray-600">Again</div>
                                    </div>
                                    <div className="bg-orange-50 p-3 rounded-lg">
                                        <div className="text-lg font-bold text-orange-600">{sessionStats.hardCards}</div>
                                        <div className="text-xs text-gray-600">Hard</div>
                                    </div>
                                    <div className="bg-green-50 p-3 rounded-lg">
                                        <div className="text-lg font-bold text-green-600">{sessionStats.normalCards}</div>
                                        <div className="text-xs text-gray-600">Good</div>
                                    </div>
                                    <div className="bg-blue-50 p-3 rounded-lg">
                                        <div className="text-lg font-bold text-blue-600">{sessionStats.easyCards}</div>
                                        <div className="text-xs text-gray-600">Easy</div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <button
                                        onClick={startStudySession}
                                        className="bg-blue-600 text-white py-4 px-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                                    >
                                        Study More
                                    </button>
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="bg-gray-200 text-gray-700 py-4 px-4 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                        Back Home
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }



            // Add Cards Menu Screen
if (currentScreen === 'addCardsMenu') {
    return (
        <div className="min-h-screen bg-gradient-to-br from-green-600 to-teal-700 p-4 flex items-center justify-center">
            <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full">
                <div className="flex items-center mb-6">
                    <button
                        onClick={() => setCurrentScreen('home')}
                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                    >
                        ← Back
                    </button>
                    <h2 className="text-2xl font-bold text-gray-800">Add New Cards</h2>
                </div>

                <div className="text-5xl mb-6">➕</div>
                <p className="text-gray-600 mb-8">Choose how you'd like to add new vocabulary cards</p>

                <div className="space-y-4">
                    {/* Manual Add Block */}
                    <div 
                        onClick={() => setCurrentScreen('manualAdd')}
                        className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
                    >
                        <div className="flex items-center justify-between">
                            <div className="text-left">
                                <div className="text-xl font-bold mb-1">Manual Entry</div>
                                <div className="text-sm opacity-90">Add cards one by one</div>
                            </div>
                            <div className="text-3xl">✏️</div>
                        </div>
                    </div>

                    {/* CSV Import Block */}
                    <div 
                        onClick={() => csvInputRef.current?.click()}
                        className="bg-gradient-to-r from-orange-500 to-red-500 rounded-xl p-6 text-white cursor-pointer transform transition-all duration-300 hover:-translate-y-1 hover:shadow-xl"
                    >
                        <div className="flex items-center justify-between">
                            <div className="text-left">
                                <div className="text-xl font-bold mb-1">Import CSV</div>
                                <div className="text-sm opacity-90">Bulk upload from file</div>
                            </div>
                            <div className="text-3xl">📄</div>
                        </div>
                    </div>
                </div>

                <div className="mt-8 p-4 bg-gray-50 rounded-lg">
                    <div className="text-sm text-gray-600">
                        <strong>CSV Format:</strong> czech_word,english_word<br/>
                        Example: dobrý den,good day
                    </div>
                </div>

                {/* Hidden CSV input */}
                <input
                    ref={csvInputRef}
                    type="file"
                    accept=".csv"
                    onChange={handleCsvUpload}
                    className="hidden"
                />
            </div>
        </div>
    );
}
            // CSV Processing Screen
            if (currentScreen === 'csvProcessing') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-600 to-red-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <div className="text-6xl mb-6">📄</div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Processing CSV</h2>
                                
                                {isProcessingCsv ? (
                                    <div>
                                        <div className="animate-spin rounded-full h-16 w-16 border-4 border-orange-500 border-t-transparent mx-auto mb-4"></div>
                                        <p className="text-gray-600">Reading your CSV file...</p>
                                        <p className="text-sm text-gray-500 mt-2">Supports up to 300 cards</p>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="text-4xl mb-4">✅</div>
                                        <p className="text-gray-600 mb-6">Processing complete!</p>
                                        
                                        {csvCards.length > 0 ? (
                                            <div>
                                                <p className="text-green-600 font-semibold mb-2">
                                                    Found {csvCards.length} vocabulary pairs
                                                </p>
                                                {csvValidationResults.length > 0 && (
                                                    <div className="mb-4">
                                                        <p className="text-sm text-gray-600">
                                                            ✅ Valid: {csvValidationResults.filter(v => v.isValid).length} | 
                                                            ⚠️ Needs review: {csvValidationResults.filter(v => !v.isValid).length}
                                                        </p>
                                                    </div>
                                                )}
                                                <button
                                                    onClick={() => setCurrentScreen('editCsvCards')}
                                                    className="w-full bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors mb-3"
                                                >
                                                    Review & Edit Cards
                                                </button>
                                            </div>
                                        ) : (
                                            <div>
                                                <p className="text-red-600 mb-4">No vocabulary pairs found in CSV.</p>
                                                <div className="text-sm text-gray-600 mb-4 p-3 bg-gray-50 rounded">
                                                    Expected format:<br/>
                                                    <code>czech_word,english_word<br/>
                                                    dobrý den,good day<br/>
                                                    děkuji,thank you</code>
                                                </div>
                                            </div>
                                        )}
                                        
                                        <button
                                            onClick={() => setCurrentScreen('home')}
                                            className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                        >
                                            Back to Home
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Edit CSV Cards Screen
            if (currentScreen === 'editCsvCards') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-orange-600 to-red-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl">
                                <div className="flex items-center justify-between p-6 border-b">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-xl font-semibold">Review CSV Cards ({csvCards.length})</h2>
                                    <div></div>
                                </div>
                                
                                <div className="p-6">
                                    <div className="max-h-96 overflow-y-auto mb-6">
                                        {csvCards.map((card, index) => {
                                            const validation = csvValidationResults[index];
                                            const isValid = !validation || validation.isValid || card.manuallyApproved;
                                            
                                            return (
                                                <div key={index} className={`p-4 rounded-lg mb-4 border-2 ${
                                                    isValid ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'
                                                }`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center">
                                                            <span className="text-sm text-gray-500 mr-2">Card {index + 1}</span>
                                                            {isValid ? (
                                                                <span className="text-green-600 text-sm">✅ Valid</span>
                                                            ) : (
                                                                <span className="text-yellow-600 text-sm">⚠️ Needs review</span>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {!isValid && (
                                                                <button
                                                                    onClick={() => approveCsvCard(index)}
                                                                    className="text-green-600 hover:text-green-700 text-sm px-2 py-1 bg-green-100 rounded"
                                                                >
                                                                    Approve
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => removeCsvCard(index)}
                                                                className="text-red-500 hover:text-red-700 text-sm px-2 py-1 bg-red-100 rounded"
                                                            >
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {validation && !validation.isValid && !card.manuallyApproved && (
                                                        <div className="mb-3 p-2 bg-yellow-100 rounded text-sm">
                                                            <strong>Issues detected:</strong>
                                                            <ul className="list-disc list-inside text-yellow-700">
                                                                {validation.issues.map((issue, i) => (
                                                                    <li key={i}>{issue}</li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="space-y-3">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                Czech {!validation?.czechValid && !card.manuallyApproved && (
                                                                    <span className="text-red-500">⚠️</span>
                                                                )}
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={card.czech}
                                                                onChange={(e) => editCsvCard(index, 'czech', e.target.value)}
                                                                className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                            />
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                English {!validation?.englishValid && !card.manuallyApproved && (
                                                                    <span className="text-red-500">⚠️</span>
                                                                )}
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={card.english}
                                                                onChange={(e) => editCsvCard(index, 'english', e.target.value)}
                                                                className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {csvCards.length > 0 && (
                                        <div className="mb-4 p-3 bg-orange-50 rounded-lg">
                                            <div className="text-sm text-orange-700">
                                                <strong>Summary:</strong> {csvCards.filter((_, i) => !csvValidationResults[i] || csvValidationResults[i].isValid || csvCards[i].manuallyApproved).length} cards ready to add
                                            </div>
                                        </div>
                                    )}
                                    
                                    {csvCards.length > 0 && (
                                        <button
                                            onClick={addCsvCardsToVocabulary}
                                            className="w-full bg-orange-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-orange-700 transition-colors mb-3"
                                        >
                                            Add Valid Cards to Vocabulary
                                        </button>
                                    )}
                                    
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
if (currentScreen === 'feedback') {
    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-600 to-green-700 p-4 flex items-center justify-center">
            <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-md w-full">
                <div className="flex items-center mb-6">
                    <button
                        onClick={() => setCurrentScreen('home')}
                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                    >
                        ← Back
                    </button>
                    <h2 className="text-2xl font-bold text-gray-800">Give Feedback</h2>
                </div>

                <form onSubmit={(e) => { e.preventDefault(); submitFeedback(); }} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Your Feedback
                        </label>
                        <textarea
                            value={feedbackText}
                            onChange={(e) => setFeedbackText(e.target.value)}
                            placeholder="Tell us about your experience..."
                            className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                            rows="4"
                            maxLength="500"
                            required
                        ></textarea>
                    </div>

                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Feedback Type
                        </label>
                        <select
    value={feedbackType}
    onChange={(e) => setFeedbackType(e.target.value)}
    className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
    required
>
    <option value="">Select type...</option>
    <option value="bug">🐞 Bug</option>
    <option value="suggestion">💡 Suggestion</option>
    <option value="praise">🎉 Praise</option>
    <option value="other">❓ Other</option>
</select>

                    </div>

                    <div className="flex gap-4">
                        <button
                            type="submit"
                            className="flex-1 bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors"
                        >
                            Submit
                        </button>
                        <button
                            type="button"
                            onClick={() => setCurrentScreen('home')}
                            className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                        >
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}

            return null;
        };

        ReactDOM.render(<CzechFlashcardApp />, document.getElementById('root'));
    </script>
</body>
</html>
