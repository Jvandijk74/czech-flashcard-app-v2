<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Czech Flashcard App - Multi-User</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🇨🇿</text></svg>">
    <meta name="description" content="Learn Czech vocabulary with multi-user cloud-synced flashcards!">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#3B82F6">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createClient } = supabase;

        // Supabase credentials
        const supabaseUrl = 'https://luydswutvsttbpvruylm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eWRzd3V0dnN0dGJwdnJ1eWxtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MDQzMjgsImV4cCI6MjA2NDE4MDMyOH0.RvrljR2_T4oDCWkyrvCxPSRc7aiUYflzQ8sX_cU-urI';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        const CzechFlashcardApp = () => {
            // All state variables
            const [currentScreen, setCurrentScreen] = useState('login');
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [studyCards, setStudyCards] = useState([]);
            const [correctCount, setCorrectCount] = useState(0);
            const [incorrectCount, setIncorrectCount] = useState(0);
            const [allVocabulary, setAllVocabulary] = useState([]);
            const [isProcessingImage, setIsProcessingImage] = useState(false);
            const [newCards, setNewCards] = useState([]);
            const [validationResults, setValidationResults] = useState([]);
            const [isValidating, setIsValidating] = useState(false);
            const [manualCzech, setManualCzech] = useState('');
            const [manualEnglish, setManualEnglish] = useState('');
            const [userId, setUserId] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [lastSyncTime, setLastSyncTime] = useState(null);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [connectionError, setConnectionError] = useState(null);
            const fileInputRef = useRef(null);

            // User management functions with Supabase
            const registerUser = async (email, password, username) => {
                try {
                    setIsLoading(true);
                    setConnectionError(null);
                    
                    // Register with Supabase Auth
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                username: username
                            }
                        }
                    });

                    if (error) {
                        console.error('Registration error:', error);
                        setConnectionError(`Registration failed: ${error.message}`);
                        return false;
                    }

                    alert('Registration successful! Please check your email to verify your account, then sign in.');
                    return true;
                } catch (error) {
                    console.error('Registration error:', error);
                    setConnectionError('Registration failed. Please check your internet connection and try again.');
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const loginUser = async (email, password) => {
                try {
                    setIsLoading(true);
                    setConnectionError(null);
                    
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });

                    if (error) {
                        console.error('Login error:', error);
                        setConnectionError(`Login failed: ${error.message}`);
                        return false;
                    }

                    return data.user;
                } catch (error) {
                    console.error('Login error:', error);
                    setConnectionError('Login failed. Please check your internet connection and try again.');
                    return false;
                } finally {
                    setIsLoading(false);
                }
            };

            const logoutUser = async () => {
                try {
                    await supabaseClient.auth.signOut();
                    setIsLoggedIn(false);
                    setCurrentUser(null);
                    setUserId('');
                    setAllVocabulary([]);
                    setEmail('');
                    setPassword('');
                    setCurrentScreen('login');
                    setLastSyncTime(null);
                } catch (error) {
                    console.error('Logout error:', error);
                }
            };

            const loadUserVocabulary = async (user) => {
                try {
                    setIsLoading(true);
                    
                    const { data, error } = await supabaseClient
                        .from('user_vocabulary')
                        .select('vocabulary, updated_at')
                        .eq('user_id', user.id)
                        .single();

                    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows found
                        console.error('Error loading vocabulary:', error);
                        setAllVocabulary([]);
                        return;
                    }

                    if (data) {
                        setAllVocabulary(data.vocabulary || []);
                        setLastSyncTime(new Date(data.updated_at));
                    } else {
                        setAllVocabulary([]);
                    }
                } catch (error) {
                    console.error('Error loading vocabulary:', error);
                    setAllVocabulary([]);
                } finally {
                    setIsLoading(false);
                }
            };

            const saveToDatabase = async (vocabulary) => {
                if (!currentUser || isSyncing) return;
                
                try {
                    setIsSyncing(true);
                    
                    const { error } = await supabaseClient
                        .from('user_vocabulary')
                        .upsert({
                            user_id: currentUser.id,
                            vocabulary: vocabulary,
                            updated_at: new Date().toISOString()
                        });

                    if (error) {
                        console.error('Error saving vocabulary:', error);
                        alert('Failed to sync vocabulary. Please try again.');
                    } else {
                        setLastSyncTime(new Date());
                        console.log('Successfully synced vocabulary');
                    }
                } catch (error) {
                    console.error('Error saving vocabulary:', error);
                    alert('Sync failed due to network error. Please check your connection.');
                } finally {
                    // Add a small delay before allowing next sync
                    setTimeout(() => {
                        setIsSyncing(false);
                    }, 1000);
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!email.trim() || !password.trim()) {
                    setConnectionError('Please enter both email and password');
                    return;
                }

                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email.trim())) {
                    setConnectionError('Please enter a valid email address');
                    return;
                }

                if (isRegistering) {
                    // For registration, use email prefix as username if no separate username provided
                    const usernameForRegistration = email.split('@')[0]; // Use email prefix as username
                    
                    const success = await registerUser(email.trim(), password, usernameForRegistration);
                    if (success) {
                        setIsRegistering(false);
                        setPassword('');
                    }
                } else {
                    const user = await loginUser(email.trim(), password);
                    if (user) {
                        setCurrentUser(user);
                        setUserId(user.id);
                        setIsLoggedIn(true);
                        setCurrentScreen('home');
                        await loadUserVocabulary(user);
                    }
                }
            };

            const handleLogout = () => {
                logoutUser();
            };

            // Study functions
            const shuffleCards = () => {
                const shuffled = [...allVocabulary].sort(() => Math.random() - 0.5);
                setStudyCards(shuffled);
            };

            const startStudySession = () => {
                shuffleCards();
                setCurrentCardIndex(0);
                setShowAnswer(false);
                setCorrectCount(0);
                setIncorrectCount(0);
                setCurrentScreen('study');
            };

            const handleAnswer = (isCorrect) => {
                if (isCorrect) {
                    setCorrectCount(prev => prev + 1);
                } else {
                    setIncorrectCount(prev => prev + 1);
                }

                setTimeout(() => {
                    if (currentCardIndex < studyCards.length - 1) {
                        setCurrentCardIndex(prev => prev + 1);
                        setShowAnswer(false);
                    } else {
                        setCurrentScreen('results');
                    }
                }, 500);
            };

            const addManualCard = (czech, english) => {
                if (!czech.trim() || !english.trim()) {
                    alert('Please fill in both Czech and English fields');
                    return;
                }
                
                const newCard = { czech: czech.trim(), english: english.trim() };
                const updatedVocabulary = [...allVocabulary, newCard];
                setAllVocabulary(updatedVocabulary);
                setManualCzech('');
                setManualEnglish('');
                alert('Card added successfully!');
                
                // Manual sync after adding card
                setTimeout(() => {
                    saveToDatabase(updatedVocabulary);
                }, 500);
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                addManualCard(manualCzech, manualEnglish);
            };

            const forceSync = async () => {
                await saveToDatabase(allVocabulary);
            };

            // Image processing functions
            const validateCzechWord = (word) => {
                const cleanWord = word.toLowerCase().trim();
                const czechChars = ['č', 'š', 'ž', 'ř', 'ď', 'ť', 'ň', 'ů', 'á', 'é', 'í', 'ó', 'ú', 'ý'];
                const hasCzechChars = czechChars.some(char => cleanWord.includes(char));
                return hasCzechChars || cleanWord.length >= 3;
            };

            const validateEnglishWord = (word) => {
                const cleanWord = word.toLowerCase().trim();
                const englishPattern = /^[a-z\s\-'\.]+$/i;
                return englishPattern.test(cleanWord) && cleanWord.length >= 1;
            };

            const validateCardPair = (czech, english) => {
                const czechValid = validateCzechWord(czech);
                const englishValid = validateEnglishWord(english);
                
                return {
                    isValid: czechValid && englishValid,
                    czechValid,
                    englishValid,
                    issues: [
                        ...(!czechValid ? ['Czech word might be incorrect'] : []),
                        ...(!englishValid ? ['English word might be incorrect'] : [])
                    ]
                };
            };

            const parseExtractedText = (text) => {
                console.log('Parsing text:', text);
                
                const lines = text.split('\n').filter(line => line.trim());
                const parsed = [];
                const validationRes = [];

                lines.forEach((line, index) => {
                    // Clean up the line
                    const cleanLine = line.trim().replace(/[""]/g, '"').replace(/['']/g, "'");
                    
                    // Try multiple patterns for Czech-English pairs
                    const patterns = [
                        /^(.+?)\s*[-–—]\s*(.+)$/,           // dash variants
                        /^(.+?)\s*[:]\s*(.+)$/,             // colon
                        /^(.+?)\s*[→➜]\s*(.+)$/,           // arrows
                        /^(.+?)\s*[=]\s*(.+)$/,             // equals
                        /^(.+?)\s*[|]\s*(.+)$/,             // pipe
                        /^(.+?)\s+([A-Za-z].*)$/,           // space separated (if second part starts with letter)
                        /^(.+?)\s*[,]\s*(.+)$/,             // comma
                        /^(.+?)\s*[;]\s*(.+)$/,             // semicolon
                    ];
                    
                    let match = null;
                    for (const pattern of patterns) {
                        match = cleanLine.match(pattern);
                        if (match) break;
                    }
                    
                    if (match && parsed.length < 200) {
                        let czech = match[1].trim();
                        let english = match[2].trim();
                        
                        // Clean up common OCR artifacts
                        czech = czech.replace(/[|]/g, 'l').replace(/[0]/g, 'o').replace(/[5]/g, 's');
                        english = english.replace(/[|]/g, 'l').replace(/[0]/g, 'o').replace(/[5]/g, 's');
                        
                        // Remove quotes if they wrap the entire string
                        czech = czech.replace(/^["'](.*)["']$/, '$1');
                        english = english.replace(/^["'](.*)["']$/, '$1');
                        
                        // Skip if either part is too short or contains mostly numbers/symbols
                        if (czech.length >= 2 && english.length >= 2 && 
                            !/^\d+$/.test(czech) && !/^\d+$/.test(english) &&
                            !/^[^a-zA-ZáčďéěíňóřšťúůýžÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ]+$/.test(czech) &&
                            !/^[^a-zA-Z]+$/.test(english)) {
                            
                            const validation = validateCardPair(czech, english);
                            parsed.push({ czech, english, id: index });
                            validationRes.push(validation);
                            
                            console.log(`Found pair: "${czech}" - "${english}"`);
                        }
                    }
                });

                console.log(`Parsed ${parsed.length} pairs`);
                setNewCards(parsed);
                setValidationResults(validationRes);
                
                if (parsed.length > 0) {
                    setIsValidating(true);
                    setTimeout(() => {
                        setIsValidating(false);
                    }, 1500);
                } else {
                    // If no pairs found, show the raw text to user for manual input
                    alert(`No vocabulary pairs detected. Raw text extracted:\n\n${text}\n\nYou can add cards manually instead.`);
                }
            };

            const preprocessImage = (file) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = () => {
                        // Set canvas size
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Draw image
                        ctx.drawImage(img, 0, 0);
                        
                        // Get image data
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        // Convert to grayscale and increase contrast
                        for (let i = 0; i < data.length; i += 4) {
                            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                            // Increase contrast
                            const contrast = gray > 128 ? 255 : 0;
                            data[i] = contrast;     // red
                            data[i + 1] = contrast; // green
                            data[i + 2] = contrast; // blue
                        }
                        
                        // Put the modified image data back
                        ctx.putImageData(imageData, 0, 0);
                        
                        // Convert to blob
                        canvas.toBlob(resolve, 'image/png');
                    };
                    
                    img.src = URL.createObjectURL(file);
                });
            };

            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setIsProcessingImage(true);
                setCurrentScreen('imageProcessing');

                try {
                    console.log('Starting OCR process...');
                    
                    if (window.Tesseract) {
                        // Preprocess the image for better OCR
                        const processedImage = await preprocessImage(file);
                        
                        // Enhanced OCR configuration
                        const { data: { text } } = await window.Tesseract.recognize(processedImage, 'ces+eng', {
                            logger: m => {
                                console.log(m);
                                if (m.status === 'recognizing text') {
                                    // You could add a progress bar here
                                }
                            },
                            tessedit_pageseg_mode: '6', // Assume uniform block of text
                            tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyzáčďéěíňóřšťúůýžÁČĎÉĚÍŇÓŘŠŤÚŮÝŽ0123456789 -:→=.,!?()[]{}/"\'',
                            preserve_interword_spaces: '1',
                        });
                        
                        console.log('OCR Result:', text);
                        
                        if (text.trim()) {
                            parseExtractedText(text);
                        } else {
                            // Fallback: Ask user to manually enter text
                            const userText = prompt(`OCR couldn't extract clear text. Please manually enter the Czech-English pairs you see in the image (format: "czech - english", one per line):`);
                            if (userText) {
                                parseExtractedText(userText);
                            } else {
                                setCurrentScreen('home');
                            }
                        }
                    } else {
                        // Fallback: Ask user to manually enter text they see in the image
                        const userText = prompt(`OCR library not loaded. Please manually enter the Czech-English pairs you see in the image (format: "czech - english", one per line):`);
                        if (userText) {
                            parseExtractedText(userText);
                        } else {
                            setCurrentScreen('home');
                        }
                    }
                } catch (error) {
                    console.error('Error processing image:', error);
                    
                    // Fallback: Ask user to manually enter text
                    const userText = prompt(`Error processing image. Please manually enter the Czech-English pairs you see (format: "czech - english", one per line):`);
                    if (userText) {
                        parseExtractedText(userText);
                    } else {
                        alert('Error processing image. Please try again with a clearer image.');
                        setCurrentScreen('home');
                    }
                }
                
                setIsProcessingImage(false);
            };

            const addNewCardsToVocabulary = () => {
                const validCards = newCards.filter((card, index) => {
                    const validation = validationResults[index];
                    return !validation || validation.isValid || card.manuallyApproved;
                });
                
                const updatedVocabulary = [...allVocabulary, ...validCards];
                setAllVocabulary(updatedVocabulary);
                setNewCards([]);
                setValidationResults([]);
                setCurrentScreen('home');
                alert(`Added ${validCards.length} new cards to your vocabulary!`);
                
                // Manual sync after adding cards from image
                setTimeout(() => {
                    saveToDatabase(updatedVocabulary);
                }, 500);
            };

            const approveCard = (index) => {
                const updated = [...newCards];
                updated[index].manuallyApproved = true;
                setNewCards(updated);
            };

            const editCard = (index, field, value) => {
                const updated = [...newCards];
                updated[index][field] = value;
                setNewCards(updated);
            };

            const removeCard = (index) => {
                const updated = newCards.filter((_, i) => i !== index);
                setNewCards(updated);
            };

            // Initialize app and check for existing session
            useEffect(() => {
                const checkSession = async () => {
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        
                        if (session?.user) {
                            setCurrentUser(session.user);
                            setUserId(session.user.id);
                            setEmail(session.user.email);
                            setIsLoggedIn(true);
                            setCurrentScreen('home');
                            await loadUserVocabulary(session.user);
                        }
                    } catch (error) {
                        console.error('Session check error:', error);
                    }
                };

                checkSession();

                // Listen for auth changes
                const { data: { subscription } } = supabaseClient.auth.onAuthStateChange(
                    async (event, session) => {
                        if (event === 'SIGNED_IN' && session?.user) {
                            setCurrentUser(session.user);
                            setUserId(session.user.id);
                            setEmail(session.user.email);
                            setIsLoggedIn(true);
                            setCurrentScreen('home');
                            await loadUserVocabulary(session.user);
                        } else if (event === 'SIGNED_OUT') {
                            setCurrentUser(null);
                            setUserId('');
                            setEmail('');
                            setIsLoggedIn(false);
                            setCurrentScreen('login');
                            setAllVocabulary([]);
                            setLastSyncTime(null);
                        }
                    }
                );

                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                // Auto-save vocabulary when it changes (but not during initial load)
                if (allVocabulary.length > 0 && !isLoading && currentUser && isLoggedIn && !isSyncing) {
                    const timeoutId = setTimeout(() => {
                        saveToDatabase(allVocabulary);
                    }, 3000); // Increased to 3 seconds to reduce frequency

                    return () => clearTimeout(timeoutId);
                }
            }, [allVocabulary, currentUser?.id]); // Simplified dependencies

            const currentCard = studyCards[currentCardIndex];

            // Login Screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="text-6xl mb-4">🇨🇿</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Czech Flashcards</h1>
                                <p className="text-gray-600">
                                    {isRegistering ? 'Create your account' : 'Sign in to your account'}
                                </p>
                            </div>

                            {connectionError && (
                                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                                    <div className="text-red-800 text-sm">{connectionError}</div>
                                </div>
                            )}

                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address
                                    </label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="Enter your email address"
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                                        required
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Password
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Enter your password"
                                        className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg"
                                        required
                                        minLength="6"
                                    />
                                </div>

                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-full bg-blue-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
                                >
                                    {isLoading ? 'Processing...' : (isRegistering ? 'Create Account' : 'Sign In')}
                                </button>
                            </form>

                            <div className="mt-6 text-center">
                                <button
                                    onClick={() => {
                                        setIsRegistering(!isRegistering);
                                        setPassword('');
                                        setConnectionError(null);
                                    }}
                                    className="text-blue-600 hover:text-blue-700 underline"
                                >
                                    {isRegistering ? 'Already have an account? Sign in' : 'Need an account? Register'}
                                </button>
                            </div>

                            <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-semibold text-blue-800 mb-2">🌟 Features:</h3>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li>• True cross-device sync with Supabase</li>
                                    <li>• Personal vocabulary collection</li>
                                    <li>• Add cards manually or from images</li>
                                    <li>• Smart Czech-English validation</li>
                                </ul>
                            </div>

                            <div className="mt-6 text-center">
                                <div className="text-xs text-gray-500">
                                    🌐 Your account works on any device • 🔒 Secure authentication
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Loading Screen
            if (isLoading && currentScreen === 'home') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4 flex items-center justify-center">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Loading Your Cards</h2>
                            <p className="text-gray-600">Syncing with database...</p>
                        </div>
                    </div>
                );
            }

            // Home Screen
            if (currentScreen === 'home') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <div className="flex justify-between items-center mb-6">
                                    <div className="text-left">
                                        <div className="text-sm text-gray-500">Welcome back,</div>
                                        <div className="font-semibold text-gray-800">
                                            {currentUser?.user_metadata?.username || currentUser?.email?.split('@')[0]}
                                        </div>
                                    </div>
                                    <button
                                        onClick={handleLogout}
                                        className="text-sm text-red-600 hover:text-red-700 underline"
                                    >
                                        Logout
                                    </button>
                                </div>

                                <div className="text-6xl mb-6">🇨🇿</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-4">Czech Vocabulary</h1>
                                <p className="text-gray-600 mb-8">Your personal flashcard collection</p>
                                
                                <div className="grid grid-cols-2 gap-6 mb-6">
                                    <div className="bg-blue-50 p-6 rounded-xl">
                                        <div className="text-3xl font-bold text-blue-600">{allVocabulary.length}</div>
                                        <div className="text-sm text-gray-600">Your Cards</div>
                                    </div>
                                    <div className="bg-green-50 p-6 rounded-xl">
                                        <div className="text-3xl font-bold text-green-600">A1-A2</div>
                                        <div className="text-sm text-gray-600">Level</div>
                                    </div>
                                </div>

                                <div className="mb-6 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex justify-between items-center">
                                        <div className="text-sm text-gray-600">
                                            {isSyncing ? (
                                                <span className="flex items-center">
                                                    <div className="animate-spin w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full mr-2"></div>
                                                    Syncing...
                                                </span>
                                            ) : (
                                                <span className="flex items-center">
                                                    <div className="w-2 h-2 bg-green-500 rounded-full mr-2"></div>
                                                    {lastSyncTime ? `Synced ${lastSyncTime.toLocaleTimeString()}` : 'Ready to sync'}
                                                </span>
                                            )}
                                        </div>
                                        <button
                                            onClick={forceSync}
                                            disabled={isSyncing}
                                            className="text-blue-600 hover:text-blue-700 text-sm underline disabled:opacity-50"
                                        >
                                            Sync
                                        </button>
                                    </div>
                                </div>

                                {allVocabulary.length === 0 ? (
                                    <div className="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <div className="text-yellow-800 font-semibold mb-2">🚀 Get Started!</div>
                                        <div className="text-sm text-yellow-700">
                                            Your vocabulary is empty. Add your first cards using the buttons below!
                                        </div>
                                    </div>
                                ) : (
                                    <button
                                        onClick={startStudySession}
                                        className="w-full bg-blue-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-blue-700 transition-colors mb-4"
                                    >
                                        Start Study Session
                                    </button>
                                )}

                                {allVocabulary.length > 0 && (
                                    <button
                                        onClick={() => setCurrentScreen('browse')}
                                        className="w-full bg-gray-200 text-gray-700 py-4 px-6 rounded-xl font-semibold text-lg hover:bg-gray-300 transition-colors mb-4"
                                    >
                                        Browse All Cards ({allVocabulary.length})
                                    </button>
                                )}

                                <button
                                    onClick={() => setCurrentScreen('manualAdd')}
                                    className="w-full bg-green-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-green-700 transition-colors mb-4"
                                >
                                    Add Card Manually
                                </button>

                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    className="w-full bg-purple-600 text-white py-4 px-6 rounded-xl font-semibold text-lg hover:bg-purple-700 transition-colors"
                                >
                                    Add Cards from Image
                                </button>

                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                    className="hidden"
                                />
                            </div>
                        </div>
                    </div>
                );
            }

            // Manual Add Screen
            if (currentScreen === 'manualAdd') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8">
                                <div className="flex items-center mb-6">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-2xl font-bold text-gray-800">Add New Card</h2>
                                </div>

                                <form onSubmit={handleManualSubmit} className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Czech Word/Phrase
                                        </label>
                                        <input
                                            type="text"
                                            value={manualCzech}
                                            onChange={(e) => setManualCzech(e.target.value)}
                                            placeholder="Enter Czech word..."
                                            className="w-full p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                                            required
                                        />
                                    </div>

                                    <div className="flex gap-4">
                                        <button
                                            type="submit"
                                            className="flex-1 bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors"
                                        >
                                            Add Card
                                        </button>
                                        <button
                                            type="button"
                                            onClick={() => setCurrentScreen('home')}
                                            className="flex-1 bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                        >
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                );
            }

            // Browse Screen
            if (currentScreen === 'browse') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl">
                                <div className="flex items-center p-6 border-b">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-xl font-semibold">All Vocabulary ({allVocabulary.length} cards)</h2>
                                </div>
                                
                                <div className="max-h-96 overflow-y-auto">
                                    {allVocabulary.map((card, index) => (
                                        <div key={index} className="flex justify-between items-center p-4 border-b last:border-b-0 hover:bg-gray-50">
                                            <div className="flex flex-col">
                                                <span className="font-bold text-lg text-red-600">{card.czech}</span>
                                                <span className="text-gray-600">{card.english}</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Study Screen
            if (currentScreen === 'study') {
                if (!currentCard) return <div>Loading...</div>;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="flex items-center justify-between mb-6">
                                <button
                                    onClick={() => setCurrentScreen('home')}
                                    className="p-3 text-white hover:bg-white hover:bg-opacity-20 rounded-full"
                                >
                                    Home
                                </button>
                                <div className="text-white bg-black bg-opacity-20 px-4 py-2 rounded-full font-semibold">
                                    {currentCardIndex + 1} / {studyCards.length}
                                </div>
                                <button
                                    onClick={() => {
                                        setCurrentCardIndex(0);
                                        setShowAnswer(false);
                                        setCorrectCount(0);
                                        setIncorrectCount(0);
                                        shuffleCards();
                                    }}
                                    className="p-3 text-white hover:bg-white hover:bg-opacity-20 rounded-full"
                                >
                                    Reset
                                </button>
                            </div>

                            <div className="bg-white bg-opacity-30 rounded-full h-3 mb-6">
                                <div 
                                    className="bg-yellow-400 h-3 rounded-full transition-all duration-500"
                                    style={{ width: `${((currentCardIndex + 1) / studyCards.length) * 100}%` }}
                                />
                            </div>

                            <div className="flex gap-4 mb-6">
                                <div className="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center font-semibold">
                                    Correct: {correctCount}
                                </div>
                                <div className="bg-red-500 text-white px-4 py-2 rounded-lg flex items-center font-semibold">
                                    Wrong: {incorrectCount}
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6 min-h-64 flex flex-col justify-center items-center text-center">
                                <div className="text-4xl font-bold text-red-600 mb-6">
                                    {currentCard.czech}
                                </div>
                                
                                {showAnswer && (
                                    <div className="text-2xl text-green-600 border-t-2 border-gray-200 pt-6 mt-6 w-full">
                                        {currentCard.english}
                                    </div>
                                )}
                            </div>

                            {!showAnswer ? (
                                <button
                                    onClick={() => setShowAnswer(true)}
                                    className="w-full bg-yellow-500 text-white py-4 px-6 rounded-xl font-bold text-xl hover:bg-yellow-600 transition-colors"
                                >
                                    Show Answer
                                </button>
                            ) : (
                                <div className="grid grid-cols-2 gap-4">
                                    <button
                                        onClick={() => handleAnswer(false)}
                                        className="bg-red-500 text-white py-4 px-6 rounded-xl font-bold text-lg hover:bg-red-600 transition-colors"
                                    >
                                        Wrong
                                    </button>
                                    <button
                                        onClick={() => handleAnswer(true)}
                                        className="bg-green-500 text-white py-4 px-6 rounded-xl font-bold text-lg hover:bg-green-600 transition-colors"
                                    >
                                        Correct
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Results Screen
            if (currentScreen === 'results') {
                const totalCards = correctCount + incorrectCount;
                const accuracy = totalCards > 0 ? Math.round((correctCount / totalCards) * 100) : 0;
                
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <div className="text-6xl mb-6">🎉</div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-8">Session Complete!</h2>
                                
                                <div className="grid grid-cols-3 gap-4 mb-8">
                                    <div className="bg-blue-50 p-6 rounded-xl">
                                        <div className="text-3xl font-bold text-blue-600">{totalCards}</div>
                                        <div className="text-sm text-gray-600">Total</div>
                                    </div>
                                    <div className="bg-green-50 p-6 rounded-xl">
                                        <div className="text-3xl font-bold text-green-600">{correctCount}</div>
                                        <div className="text-sm text-gray-600">Correct</div>
                                    </div>
                                    <div className="bg-red-50 p-6 rounded-xl">
                                        <div className="text-3xl font-bold text-red-600">{incorrectCount}</div>
                                        <div className="text-sm text-gray-600">Incorrect</div>
                                    </div>
                                </div>

                                <div className="bg-yellow-50 p-6 rounded-xl mb-8">
                                    <div className="text-4xl font-bold text-yellow-600">{accuracy}%</div>
                                    <div className="text-sm text-gray-600">Accuracy</div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <button
                                        onClick={startStudySession}
                                        className="bg-blue-600 text-white py-4 px-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors"
                                    >
                                        Study Again
                                    </button>
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="bg-gray-200 text-gray-700 py-4 px-4 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                        Back Home
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // Image Processing Screen
            if (currentScreen === 'imageProcessing') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                <div className="text-6xl mb-6">📷</div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Processing Image</h2>
                                
                                {isProcessingImage ? (
                                    <div>
                                        <div className="animate-spin rounded-full h-16 w-16 border-4 border-purple-500 border-t-transparent mx-auto mb-4"></div>
                                        <p className="text-gray-600">Extracting text from your image...</p>
                                        <p className="text-sm text-gray-500 mt-2">Supports up to 200 cards</p>
                                    </div>
                                ) : isValidating ? (
                                    <div>
                                        <div className="animate-pulse flex space-x-1 justify-center mb-4">
                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                            <div className="w-3 h-3 bg-blue-500 rounded-full"></div>
                                        </div>
                                        <p className="text-gray-600">Validating Czech-English pairs...</p>
                                    </div>
                                ) : (
                                    <div>
                                        <div className="text-4xl mb-4">✅</div>
                                        <p className="text-gray-600 mb-6">Processing complete!</p>
                                        
                                        {newCards.length > 0 ? (
                                            <div>
                                                <p className="text-green-600 font-semibold mb-2">
                                                    Found {newCards.length} vocabulary pairs
                                                </p>
                                                {validationResults.length > 0 && (
                                                    <div className="mb-4">
                                                        <p className="text-sm text-gray-600">
                                                            ✅ Valid: {validationResults.filter(v => v.isValid).length} | 
                                                            ⚠️ Needs review: {validationResults.filter(v => !v.isValid).length}
                                                        </p>
                                                    </div>
                                                )}
                                                <button
                                                    onClick={() => setCurrentScreen('editCards')}
                                                    className="w-full bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors mb-3"
                                                >
                                                    Review & Edit Cards
                                                </button>
                                            </div>
                                        ) : (
                                            <p className="text-red-600 mb-4">No vocabulary pairs found. Please try a different image.</p>
                                        )}
                                        
                                        <button
                                            onClick={() => setCurrentScreen('home')}
                                            className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                        >
                                            Back to Home
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // Edit Cards Screen
            if (currentScreen === 'editCards') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-700 p-4">
                        <div className="max-w-md mx-auto">
                            <div className="bg-white rounded-2xl shadow-2xl">
                                <div className="flex items-center justify-between p-6 border-b">
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="mr-4 p-2 text-gray-600 hover:bg-gray-100 rounded-full"
                                    >
                                        ← Back
                                    </button>
                                    <h2 className="text-xl font-semibold">Review New Cards ({newCards.length})</h2>
                                    <div></div>
                                </div>
                                
                                <div className="p-6">
                                    <div className="max-h-96 overflow-y-auto mb-6">
                                        {newCards.map((card, index) => {
                                            const validation = validationResults[index];
                                            const isValid = !validation || validation.isValid || card.manuallyApproved;
                                            
                                            return (
                                                <div key={index} className={`p-4 rounded-lg mb-4 border-2 ${
                                                    isValid ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'
                                                }`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center">
                                                            <span className="text-sm text-gray-500 mr-2">Card {index + 1}</span>
                                                            {isValid ? (
                                                                <span className="text-green-600 text-sm">✅ Valid</span>
                                                            ) : (
                                                                <span className="text-yellow-600 text-sm">⚠️ Needs review</span>
                                                            )}
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {!isValid && (
                                                                <button
                                                                    onClick={() => approveCard(index)}
                                                                    className="text-green-600 hover:text-green-700 text-sm px-2 py-1 bg-green-100 rounded"
                                                                >
                                                                    Approve
                                                                </button>
                                                            )}
                                                            <button
                                                                onClick={() => removeCard(index)}
                                                                className="text-red-500 hover:text-red-700 text-sm px-2 py-1 bg-red-100 rounded"
                                                            >
                                                                Remove
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    {validation && !validation.isValid && !card.manuallyApproved && (
                                                        <div className="mb-3 p-2 bg-yellow-100 rounded text-sm">
                                                            <strong>Issues detected:</strong>
                                                            <ul className="list-disc list-inside text-yellow-700">
                                                                {validation.issues.map((issue, i) => (
                                                                    <li key={i}>{issue}</li>
                                                                ))}
                                                            </ul>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="space-y-3">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                Czech {!validation?.czechValid && !card.manuallyApproved && (
                                                                    <span className="text-red-500">⚠️</span>
                                                                )}
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={card.czech}
                                                                onChange={(e) => editCard(index, 'czech', e.target.value)}
                                                                className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                            />
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                                                English {!validation?.englishValid && !card.manuallyApproved && (
                                                                    <span className="text-red-500">⚠️</span>
                                                                )}
                                                            </label>
                                                            <input
                                                                type="text"
                                                                value={card.english}
                                                                onChange={(e) => editCard(index, 'english', e.target.value)}
                                                                className="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {newCards.length > 0 && (
                                        <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                                            <div className="text-sm text-blue-700">
                                                <strong>Summary:</strong> {newCards.filter((_, i) => !validationResults[i] || validationResults[i].isValid || newCards[i].manuallyApproved).length} cards ready to add
                                            </div>
                                        </div>
                                    )}
                                    
                                    {newCards.length > 0 && (
                                        <button
                                            onClick={addNewCardsToVocabulary}
                                            className="w-full bg-green-600 text-white py-3 px-6 rounded-xl font-semibold hover:bg-green-700 transition-colors mb-3"
                                        >
                                            Add Valid Cards to Vocabulary
                                        </button>
                                    )}
                                    
                                    <button
                                        onClick={() => setCurrentScreen('home')}
                                        className="w-full bg-gray-200 text-gray-700 py-3 px-6 rounded-xl font-semibold hover:bg-gray-300 transition-colors"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        ReactDOM.render(<CzechFlashcardApp />, document.getElementById('root'));
    </script>
</body>
</html>-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-lg"
                                            required
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            English Translation
                                        </label>
                                        <input
                                            type="text"
                                            value={manualEnglish}
                                            onChange={(e) => setManualEnglish(e.target.value)}
                                            placeholder="Enter English translation..."
                                            className="w-full p-4 border
